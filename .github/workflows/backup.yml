name: è‡ªåŠ¨å¤‡ä»½ç¬”è®°åˆ°äº‘ç›˜

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©0ç‚¹ï¼ˆUTCï¼‰è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: è§¦å‘ Cloudflare Pages å¤‡ä»½æ¥å£
        id: backup
        run: |
          response=$(curl -s -w "%{http_code}" -o result.txt -X POST https://notes.zxlwq.dpdns.org/api/backup -H "Content-Type: application/json" -d '{}')
          echo "HTTP_RESPONSE=$response" >> $GITHUB_ENV

      - name: æ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸå¹¶å‘é€ TG é€šçŸ¥
        if: env.HTTP_RESPONSE == '200'
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_USER_ID: ${{ secrets.TG_USER_ID }}
        run: |
          MESSAGE="âœ… *ç¬”è®°è‡ªåŠ¨å¤‡ä»½æˆåŠŸï¼*\nğŸ—‚ï¸ æ—¶é—´ï¼š$(date -u '+%Y-%m-%d %H:%M:%S UTC')\nğŸŒ æ¥æºï¼šnotes.zxlwq.dpdns.org"
          curl -s -X POST https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage \
            -d chat_id=${TG_USER_ID} \
            -d text="$MESSAGE" \
            -d parse_mode=Markdown

      - name: æ¨é€å¤±è´¥æ—¶è¾“å‡ºæ—¥å¿—
        if: env.HTTP_RESPONSE != '200'
        run: |
          echo "å¤‡ä»½æ¥å£è¿”å›é 200 å“åº”ç ï¼š" $HTTP_RESPONSE
          echo "å“åº”å†…å®¹å¦‚ä¸‹ï¼š"
          cat result.txt
